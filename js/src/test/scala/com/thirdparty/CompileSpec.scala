package com.thirdparty

import com.thirdparty.defs.attrs.{AriaAttrs, HtmlAttrs, SvgAttrs}
import com.thirdparty.defs.complex.{ComplexHtmlKeys, ComplexSvgKeys}
import com.thirdparty.defs.eventProps.{DocumentEventProps, GlobalEventProps, WindowEventProps}
import com.thirdparty.defs.props.Props
import com.thirdparty.defs.styles.StyleProps
import com.thirdparty.defs.styles.units.{Calc, Color, Length, Time, Url}
import com.thirdparty.defs.tags.{HtmlTags, SvgTags}
import com.thirdparty.keys.{DerivedStyleBuilder, DerivedStyleProp, StyleProp, SvgAttr}
import com.thirdparty.setters.StyleSetter
import org.scalatest.funspec.AnyFunSpec
import org.scalatest.matchers.should.Matchers

class CompileSpec extends AnyFunSpec with Matchers {

  // This test suite checks the typical usage of SDT.
  // - It uses the code generated by GeneratorSpec.
  // - Everything in `com.thirdparty` is assumed to reside in the
  //   codebase of a UI library that depends on SDT at compile time
  //   (but not runtime). Most files under `com.thirdparty.defs` are
  //   generated at compile time as evidenced by the comment in their
  //   headers, whereas a few files are provided manually because it
  //   does not really make sense to generate them.
  // - Aside from the asserts below, this also implicitly tests that
  //   GeneratorSpec produced valid source code, and that the key
  //   names don't have conflicts in them.

  object html
    extends HtmlTags
    with HtmlAttrs
    with Props
    with ComplexHtmlKeys
    with GlobalEventProps
    with StyleProps

  object documentEvents
    extends GlobalEventProps
    with DocumentEventProps

  object windowEvents
    extends GlobalEventProps
    with WindowEventProps

  object svg
    extends SvgTags
    with SvgAttrs
    with ComplexSvgKeys

  object aria
    extends AriaAttrs

  type StyleEncoder[A] = A => String

  object style
    extends DerivedStyleBuilder[String, StyleEncoder]
    with Color[String, StyleEncoder]
    with Url[StyleEncoder]
    with Length[StyleEncoder, Int]
    with Time[StyleEncoder]
    with Calc[StyleEncoder] {

    override protected def styleSetter(value: String): String = value

    override protected def derivedStyle[A](encode: A => String): StyleEncoder[A] = encode
  }

  it("typical usage") {

    // Simple types

    assert(html.div.domName == "div")
    assert(html.onClick.domName == "click")
    assert(html.value.domName == "value")
    assert(html.idAttr.domName == "id")
    assert(html.charset.domName == "charset")
    assert(html.display.domName == "display")

    // Event props

    assert(html.onClick.domName == "click") // elements - global
    assert(html.onCopy.domName == "copy") // elements - clipboard

    assert(documentEvents.onClick.domName == "click") // document - global
    assert(documentEvents.onCopy.domName == "copy") // document - clipboard
    assert(documentEvents.onDomContentLoaded.domName == "DOMContentLoaded") // document

    assert(windowEvents.onClick.domName == "click") // window - global
    assert(windowEvents.onOnline.domName == "online") // window

    // SVG namespaces

    assert(svg.xlinkHref.namespace.contains("xlink"))
    assert(svg.xlinkHref.qualifiedName == "xlink:href")
    assert(SvgAttr.namespaceUrl(svg.xlinkHref.namespace.get) == "http://www.w3.org/1999/xlink")

    // Aliases

    assert(html.typ == html.`type`)
    assert(html.typ.domName == "type")

    assert(svg.typ == svg.`type`)
    assert(svg.typ.domName == "type")

    // Complex keys

    assert(html.cls.domName == "className")
    assert((html.cls := List("class1", "class2")).domValue == "class1 class2")

    // CSS keywords

    val s1: StyleSetter[_] = html.display.none
    val v1: String = html.display.none.value
    assert(html.display.none.value == "none")

    // Base CSS keywords
    val s2: StyleSetter[_] = html.padding.inherit
    val v2: String = html.padding.inherit.value
    assert(html.display.inherit.value == "inherit")

    // Derived CSS props (units)

    val p1: StyleProp[String] = html.padding
    val p2: DerivedStyleProp[Int] = html.padding.px
    assert((html.padding.px := 12).value == "12px")

    html.maxHeight.calc := "12px + 20em" // Length inherits Calc

    html.background.url: DerivedStyleProp[String]
    (html.background.url := "https://laminar.dev").value == """url("https://laminar.dev")"""

    assert(style.percent(55) == "55%")
    assert(style.calc("12px + 20em") == "calc(12px + 20em)")

    // Multi-parameter derived CSS props (units)

    val p3: StyleProp[String] = html.color
    val s3: StyleSetter[_] = html.color.rgb(200, 100, 0)

    assert(html.color.rgb(200, 100, 0).value == "rgb(200 100 0)")
    assert(html.color.rgb(200, 100, 0, 0.5).value == "rgb(200 100 0 / 0.5)")

    assert(style.rgb(200, 100, 0) == "rgb(200 100 0)")
    assert(style.rgb(200, 100, 0, 0.5) == "rgb(200 100 0 / 0.5)")
  }
}
